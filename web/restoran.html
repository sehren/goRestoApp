<!DOCTYPE html>
  <html>
    <head>
      <!--Import Google Icon Font-->
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <!--Import materialize.css-->
      <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
      <link rel="stylesheet" type="text/css" href="css/style.css">
      <!--Let browser know website is optimized for mobile-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <title>dashboard</title>
    </head>
    <body>
      <ul id="add1" class="dropdown-content">
        <li class="center"><b>Tambah</b></li>
        <li class="divider"></li>
        <li><a class="modal-trigger" href="/">Tambah Menu</a></li>
        <li><a href="/koki">Tambah Koki</a></li>
      </ul>
      <div class="navbar-fixed">
        <nav>
          <div class="nav-wrapper teal">
            <a href="#" data-activates="slide-out" class="button-collapse"><i class="material-icons">menu</i></a>
            <a href="#!" class="brand-logo">GORESTO</a>
            <ul class="right hide-on-med-and-down">
              <li><a class="dropdown-button" href="#" data-activates="add1"><i class="large material-icons">add</i></a></li>
            </ul>
          </div>
        </nav>
      </div>
      <!-- /end navbar -->

      <!-- content -->
      <div id="main">
        <div class="row">
          <!-- side menu -->
        <div class="side-menu">
            <ul id="slide-out" class="side-nav fixed leftside-navigation ps-container ps-active-y">
              <li>
                <div class="user-view">
                  <div class="background">
                  </div>
                  <div class="row">
                    <div class="col s4">
                      <a href="#!user" class="a"><img class="circle responsive-img valign profile-image" src="images/avatar.jpg"></a>
                    </div>
                    <div class="col s8">
                      <a class='btn-flat white-text profile-btn non-pading' href='#'>{{name}}</a>
                      <span class="white-text email">Pemilik Restoran</span>
                    </div>
                  </div>
                </div>
              </li>
              <li><a class="waves-effect" href="/"><i class="material-icons margin-icon">restaurant</i>Data Menu</a></li>
              <li><a class="waves-effect" href="/koki"><i class="material-icons margin-icon">person</i>Data Koki</a></li>
              <li><a class="waves-effect" href="/pembuatan"><i class="material-icons margin-icon">schedule</i>Pembuatan</a></li>
              <li><a class="waves-effect" href="/pesanan-masuk"><i class="material-icons margin-icon">today</i>Pesanan Masuk</a></li>
              <li><a class="waves-effect" href="/pembayaran"><i class="material-icons margin-icon">attach_money</i>Pembayaran</a></li>
              <li><a class="waves-effect" href="/meja"><i class="material-icons margin-icon">accessible</i>Manage Meja</a></li>
              <li><a class="waves-effect" href="/menuSelesai"><i class="material-icons margin-icon">send</i>Antar Pesanan</a></li>
              <li class="active"><a class="waves-effect" href="/restoran"><i class="material-icons margin-icon">settings</i>Pengaturan</a></li>
              <!-- <li><div class="divider"></div></li>
              <li><a class="subheader">Subheader</a></li> -->
              <li><a class="waves-effect" href="/logout"><i class="material-icons margin-icon">arrow_forward</i>logout</a></li>
            </ul>
        </div>
        <!-- /end side menu -->



          <!-- Teal page Content -->
          <div class="main resto">
                <div class="row">
                  <div class="col s10 center-align">
                    <h4>Data Restoran</h4>
                    <p>harap isi data restoran sebelum mengaktifkan restoran anda</p>
                  </div>
                </div>
                <div class="row">
                    <div class="col s10 center">
                      {%if resto.imageName !=''%}
                      <img class="materialboxed" width="650" src="http://localhost:3000/cover-restoran/{{resto.imageName}}"onError="this.onerror=null;this.src='http://localhost:3000/cover-restoran/No-image.jpg';">
                      {%endif%}
                    </div>
                    <div class="file-field input-field col s10">
                      <div class="btn">
                        <span>File</span>
                        <input type="file" class="image">
                      </div>
                      <div class="file-path-wrapper">
                        <input class="file-path validate" type="text" placeholder="Upload Foto Restoran">
                      </div>
                    </div>
                    <div class="input-field col s10 center">
                      <input id="nama_resto" type="text" class="validate" value="{{resto.namaRestoran}}" required>
                      <label for="nama_resto">Nama Restoran</label>
                    </div>
                    <div class="input-field col s10">
                      <input placeholder="Masukan Alamat" id="address" type="text" class="validate" required>
                      <label for="address">Alamat Restoran</label>
                    </div>
                    <div class="col s10">
                      <div id="googleMap" style="width:100%;height:400px;"></div>
                    </div>
                    <!-- <form id="frmUploader" enctype="multipart/form-data" action="api/Upload/" method="post">
                      <input type="file" name="imgUploader" multiple />
                      <input type="submit" name="submit" id="btnSubmit" value="Upload" /> 
                    </form> -->
                    
                    <div class="col s10">
                      <label for="gantiPass">Ganti Password</label>
                      <div id="gantiPass" class="row">
                        <div class="input-field col s5">
                          <label for="oldPass">Password Lama</label>
                          <input type="password" name="password" class="oldPass">
                        </div>
                        <div class="input-field col s5">
                          <label for="oldPass">Password Baru</label>
                          <input type="password" name="password" class="newPass">
                        </div>
                      </div>
                    </div>
                    <div class="col s10">
                      <label for="waktu">Waktu Operasional</label>
                      <div id="waktu" class="row">
                        <div class="input-field col s2">
                          <label for="buka">buka</label>
                          <input id="buka" type="text" class="operasional" value="{{resto.buka}}">
                        </div>
                        <div class="input-field col s2">
                          <label for="tutup">tutup</label>
                          <input id="tutup" type="text" class="operasional" value="{{resto.tutup}}">
                        </div>
                      </div>
                    </div>
                    <div class="col s10">
                        <label for="aktif">Mulai jalankan Restoran anda</label>
                        <div class="switch" id="aktif">
                            <label> 
                                Tidak
                                <input type="checkbox" class="status" {%if resto.status =='true'%} checked {%endif%}>
                                <span class="lever"></span>
                                Ya
                            </label>
                        </div>
                    </div>
                    <div class="col s10">
                      <p class="red-text"></p>
                    </div>
                    <div class="col s10">
                      <a class="waves-effect waves-light btn simpan">Simpan</a>
                    </div>
                </div>
          </div>
          <!-- end Teal page content -->
        </div>
      </div>
      
      <!-- end content -->

      <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
      <script type="text/javascript" src="js/materialize.min.js"></script>
      <script type="text/javascript" src="js/goresto.js"></script>
      <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwotoMcxgV6VSqJzw42g0NOQE6vofBI-Q&libraries=places&callback=initService"
        async defer></script>
      <script type="text/javascript">
        var idOwner = {{ idOwner | dump | safe }}
        
        var lokasi = [];
        var selected = {lat : "",lng : "",formatted_address : ""};
        var markers = [];
        var map;
        var coord = {%if resto.lat!=''%}{lat:{{resto.lat}},lng:{{resto.lng}}}{%else%}{lat : "",lng : ""}{%endif%};
        function initService() {


              map = new google.maps.Map(document.getElementById('googleMap'), {
                zoom: 8,
                center: {lat: 40.72, lng: -73.96},
                styles:  [{"stylers": [{ "saturation": -100 }]}]
              });
              var geocoder  = new google.maps.Geocoder();
              map.addListener('click', function(event) {
                map.setCenter(event.latLng)
                addMarkers(event.latLng);
                geocoder.geocode({'latLng':event.latLng},function(results,status){
                  if(status == google.maps.GeocoderStatus.OK)
                    $('#address').val(results[0].formatted_address)
                })
              });
              //get current position
              if(coord.lat == "" ){
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                      var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                      };
                      addMarkers(pos)

                      geocoder.geocode({'latLng':pos},function(results,status){
                        if(status == google.maps.GeocoderStatus.OK){
                          $('#address').val(results[0].formatted_address)
                        }
                      })
                      map.setZoom(11)
                      map.setCenter(pos);
                    }, function() {
                      handleLocationError(true, infoWindow, map.getCenter());
                    });
                  } else {
                    // Browser doesn't support Geolocation
                    handleLocationError(false, infoWindow, map.getCenter());
                  }
              }
              else{
                console.log(coord)
                addMarkers(coord)
                 geocoder.geocode({'latLng':coord},function(results,status){
                  if(status == google.maps.GeocoderStatus.OK)
                    $('#address').val(results[0].formatted_address)
                })
              }
              


              
              var input = document.getElementById('address');     
              var autocomplete = new google.maps.places.Autocomplete(input);
              google.maps.event.addListener(autocomplete, 'place_changed', function() {
                var place = autocomplete.getPlace()
                selected.lat = place.geometry.location.lat()
                selected.lng = place.geometry.location.lng()
                selected.formatted_address = place.formatted_address;
                var position = {lat : selected.lat,lng : selected.lng}
                addMarkers(position)
                map.setCenter(position)
              });
        }
        function setMapOnAll(map) {
          for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(map);
          }
        }
        function addMarkers(location){
          deleteMarkers();
          console.log(location)
          var marker = new google.maps.Marker({
            position: location,
            map: map,
            icon:{
                url: 'images/location.png',
                scaledSize: new google.maps.Size(40, 40)
            },
          });
          markers.push(marker);
          map.setCenter(location)
          map.setZoom(10)
          coord = location;
        }
        function clearMarkers() {
          setMapOnAll(null);
        }
        function deleteMarkers() {
          clearMarkers();
          markers = [];
        }
        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
          infoWindow.setPosition(pos);
          infoWindow.setContent(browserHasGeolocation ?
                                'Error: The Geolocation service failed.' :
                                'Error: Your browser doesn\'t support geolocation.');
        }
        restoImg = {{resto.imageName  | dump | safe}}
        $('.simpan').click(function(){
          var check = $('.status').prop('checked')
          oldPass = $('.oldPass').val()
          newPass = $('.newPass').val()
          istrue = false
          if(oldPass==""){
            var data = {namaRestoran : $('#nama_resto').val(),lat : coord.lat,lng:coord.lng,buka:$('#buka').val(),tutup:$('#tutup').val(),status:check,address:$('#address').val()}
            istrue = true
          }
          else if(oldPass!=""){
            if(newPass==""){
              Materialize.toast('Isi Password Baru', 4000)
            }
            else{
              var data = {namaRestoran : $('#nama_resto').val(),lat : coord.lat,lng:coord.lng,buka:$('#buka').val(),tutup:$('#tutup').val(),status:check,address:$('#address').val(),oldPass : oldPass,newPass : newPass}
              istrue = true
            }
          }
          if(istrue){
            $.post("http://localhost:3000/dashboard/data-resto",data,function(res){
              if(res=='fail'){
                $('.red-text').html('Data belum lengkap')
                $('.status').prop('checked',false)
              }
              else{
                var image = $(".image")[0].files[0];
                if(image!=undefined && res == 'sukses'){
                  var formdata = new FormData();
                  formdata.append('image', image);
                  $.ajax({
                    url: '/api/upload',
                    data: formdata,
                    contentType: false,
                    processData: false,
                    type: 'POST',
                    'success':function(data){
                        window.location.href="/restoran"
                    }
                  });
                }
                else{
                  console.log(res)
                  if(res == 'password salah'){
                    Materialize.toast('Password lama salah', 2000)
                  }
                  else
                    window.location.href="/restoran"
                }
              }
            })
          }
        })
        // $.get("http://localhost:3000/restoran",function(res,status,xhr){
            
        // })
      </script>
    </body>
  </html>